name: Sync Feishu Wiki to Content (with Auto Indexing)

on:
  schedule:
    # æ¯å¤© åŒ—äº¬æ—¶é—´ 00:00 è¿è¡Œï¼ˆGitHub Actions ä½¿ç”¨ UTCï¼Œå› æ­¤éœ€è®¾ä¸º '0 16 * * *'ï¼‰
    - cron: '0 16 * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    # ä»…åœ¨ master åˆ†æ”¯è¿è¡Œï¼ˆé€‚ç”¨äº schedule ä¸ workflow_dispatchï¼‰
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Ensure script executable
        run: chmod +x bin/feishu2md-linux-amd64 || true

      - name: Run Feishu -> content sync
        env:
          WIKI_URL: ${{ secrets.FEISHU_WIKI_URL }}
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
        run: |
          if [ -z "${WIKI_URL}" ]; then
            echo "::error::FEISHU_WIKI_URL Secret æœªé…ç½®ï¼Œæ— æ³•æ‰§è¡ŒåŒæ­¥ã€‚"
            exit 1
          fi
          if [ -z "${FEISHU_APP_ID}" ] || [ -z "${FEISHU_APP_SECRET}" ]; then
            echo "::error::ç¼ºå°‘é£ä¹¦åº”ç”¨å‡­æ®ã€‚è¯·åœ¨ä»“åº“ Settings â†’ Secrets and variables â†’ Actions ä¸­é…ç½®ï¼šFEISHU_APP_ID ä¸ FEISHU_APP_SECRETï¼ˆæ¨èä½¿ç”¨ Secretsï¼‰ã€‚"
            exit 1
          fi

          echo "Using Feishu Wiki URL and app credentials from repository configuration."
          export FEISHU_APP_ID
          export FEISHU_APP_SECRET
          bin/feishu2md-linux-amd64 -o content wiki-tree "$WIKI_URL"

      - name: Commit and push to master if changes found
        id: commit
        shell: bash
        env:
          TZ: UTC
        run: |
          set -e
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config user.name "Perfecto23"
          git config user.email "kepengcheng314@163.com"
          if [ -n "$(git status --porcelain content)" ]; then
            echo "Changes detected in content. Committing..."
            git add content
            git commit -m "chore(content): sync Feishu wiki ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
            # å¤„ç†æ½œåœ¨çš„é fast-forward æƒ…å†µ
            git pull --rebase origin master
            git push origin HEAD:master
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected in content."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

                  # ğŸš€ æ–°å¢ï¼šå¦‚æœæœ‰å†…å®¹å˜æ›´ï¼Œç›´æ¥åœ¨GitHub Actionä¸­æ£€æµ‹å˜æ›´å¹¶æäº¤ç´¢å¼•è¯·æ±‚
      - name: Auto index new articles
        if: steps.commit.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ æ£€æµ‹åˆ°å†…å®¹æ›´æ–°ï¼Œå¼€å§‹è‡ªåŠ¨ç´¢å¼•æµç¨‹..."

          # åœ¨GitHub Actionä¸­ç›´æ¥æ£€æµ‹æ–‡ä»¶å˜æ›´ï¼ˆæœ‰å®Œæ•´çš„gitå†å²ï¼‰
          echo "ğŸ” æ£€æµ‹å˜æ›´çš„æ–‡ç« ..."

          # è·å–æ–°å¢å’Œä¿®æ”¹çš„markdownæ–‡ä»¶
          changed_files=$(git diff --name-status HEAD~1..HEAD -- content/ | grep -E '^[AM]\s+.*\.md$' | grep -v '\.md\.rev$' || true)

          if [ -z "$changed_files" ]; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°Markdownæ–‡ç« å˜æ›´"
            exit 0
          fi

          # è½¬æ¢ä¸ºæ–‡ç« è·¯å¾„ï¼ˆslugï¼‰ï¼Œä¸æœ¬åœ°è„šæœ¬ä¿æŒä¸€è‡´
          article_paths=()

          # SlugåŒ–å‡½æ•°ï¼ˆä¸MDXåº“ä¿æŒä¸€è‡´ï¼‰
          slugify_segment() {
            echo "$1" | sed 's/^[0-9]*\. *//' | sed 's/[^a-zA-Z0-9\u4e00-\u9fa5]/-/g' | sed 's/-\+/-/g' | sed 's/^-\|-$//g' | tr '[:upper:]' '[:lower:]'
          }

          while IFS= read -r line; do
            if [ -n "$line" ]; then
              # æå–æ–‡ä»¶è·¯å¾„ï¼šA content/xxx.md -> xxx.md
              file_path=$(echo "$line" | sed 's/^[AM]\s*//' | sed 's/^content\///')
              
              # è¿‡æ»¤æ‰å›¾ç‰‡ç›®å½•å’Œå ä½æ–‡æ¡£
              if [[ "$file_path" != *"/img/"* && "$file_path" != *"ç©ºæ–‡æ¡£å ä½"* ]]; then
                # ç”Ÿæˆslugï¼šå¤„ç†ç›®å½•å’Œæ–‡ä»¶å
                slug_parts=""
                IFS='/' read -ra PATH_PARTS <<< "${file_path%.*}"
                for part in "${PATH_PARTS[@]}"; do
                  if [ -n "$part" ]; then
                    slugified=$(slugify_segment "$part")
                    if [ -n "$slug_parts" ]; then
                      slug_parts="$slug_parts/$slugified"
                    else
                      slug_parts="$slugified"
                    fi
                  fi
                done
                
                if [ -n "$slug_parts" ]; then
                  article_paths+=("$slug_parts")
                  echo "  ğŸ“„ $slug_parts"
                fi
              fi
            fi
          done <<< "$changed_files"

          if [ ${#article_paths[@]} -eq 0 ]; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦ç´¢å¼•çš„æœ‰æ•ˆæ–‡ç« "
            exit 0
          fi

          echo "ğŸ“ å‘ç° ${#article_paths[@]} ç¯‡æ–‡ç« éœ€è¦ç´¢å¼•"

          # æ„å»ºJSONæ•°ç»„
          paths_json="["
          for i in "${!article_paths[@]}"; do
            if [ $i -gt 0 ]; then
              paths_json+=","
            fi
            paths_json+="\"${article_paths[$i]}\""
          done
          paths_json+="]"

          # æäº¤ç´¢å¼•è¯·æ±‚
          echo "ğŸ“¤ å‘ Google æäº¤ç´¢å¼•è¯·æ±‚..."
          index_response=$(curl -s -X POST "https://itmirror.top/api/gsc/request-indexing" \
            -H "Content-Type: application/json" \
            -d "{\"paths\": $paths_json}" \
            --max-time 120 \
            --retry 3 \
            --retry-delay 10)

          # æ£€æŸ¥ç´¢å¼•ç»“æœ
          if [ $? -eq 0 ] && echo "$index_response" | grep -q '"success":true'; then
            # æå–ç»Ÿè®¡ä¿¡æ¯
            total=$(echo "$index_response" | grep -o '"total":[0-9]*' | grep -o '[0-9]*')
            success=$(echo "$index_response" | grep -o '"success":[0-9]*' | tail -1 | grep -o '[0-9]*')
            
            echo "âœ… æ–‡ç« ç´¢å¼•è¯·æ±‚æäº¤æˆåŠŸï¼"
            echo "ğŸ“Š ç´¢å¼•ç»“æœ: æˆåŠŸæäº¤ ${success:-0}/${total:-0} ç¯‡æ–‡ç« åˆ° Google"
            echo "ğŸ‰ ç´¢å¼•è¯·æ±‚å·²æäº¤ï¼Google å°†åœ¨ç¨åå¤„ç†è¿™äº›ç´¢å¼•è¯·æ±‚ã€‚"
          else
            echo "âš ï¸ ç´¢å¼•è¯·æ±‚æäº¤å¤±è´¥ï¼Œè¿™ä¸å½±å“å†…å®¹åŒæ­¥"
            echo "ğŸ” API å“åº”: $index_response"
            echo "ğŸ’¡ å¯ç¨åæ‰‹åŠ¨è¿è¡Œ: node scripts/index-articles.js auto"
          fi

      # å³ä½¿æ²¡æœ‰å†…å®¹å˜æ›´ï¼Œä¹Ÿè®°å½•ä¸€ä¸‹çŠ¶æ€
      - name: No changes detected
        if: steps.commit.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ æœ¬æ¬¡åŒæ­¥æœªå‘ç°å†…å®¹å˜æ›´ï¼Œè·³è¿‡ç´¢å¼•æ­¥éª¤"
          echo "ğŸ’¡ å¦‚éœ€æ‰‹åŠ¨æ£€æŸ¥ç´¢å¼•çŠ¶æ€: node scripts/index-articles.js status"
